$(document).ready((function(){$('[data-toggle="popover-hover"]').popover({html:!0,trigger:"hover",placement:"bottom"}),$("#ModalCreditRegisterFinanceCollect, #ModalCreditRegisterFinanceBonification").on("change",(function(){var e=$(this).attr("id");!0===$(this).prop("checked")&&("ModalCreditRegisterFinanceCollect"===e?$("#ModalCreditRegisterFinanceBonification").prop("checked",!1):$("#ModalCreditRegisterFinanceCollect").prop("checked",!1))})),$("#users, #UserSearchDiv").on("click",".btn-credit",(function(a){var t=$(this);if(t.hasClass("disabled"))return!1;if("UserSearchDiv"===a.delegateTarget.id){if(""===(r=$("#UserSearch").val()))return!1;$("body").data("quick_use_section","quick")}else{var r=$(this).closest("tr").attr("user-id");$("body").data("quick_use_section","users"),$("#ModalCreditLoading").show(),$("#ModalCredit").modal("show")}$.ajax({url:"services/operation_get_modal_balances.php",type:"post",data:{user_id:r,target:$("body").data("quick_use_section"),token:$("body").data("session_token")},cache:!1,success:function(a){"quick"===$("body").data("quick_use_section")&&($("#ModalCreditLoading").show(),$("#ModalCredit").modal("show"));var r=$.parseJSON(a);$.each(r,(function(a,r){1==r.position?($("#ModalCreditSourceId").val(r.user_id),r.username.length>11||r.balance.length>10?($("#ModalCreditSourceUsername").addClass("px-1"),$("#ModalCreditSourceBalance").addClass("px-1")):($("#ModalCreditSourceUsername").removeClass("px-1"),$("#ModalCreditSourceBalance").removeClass("px-1")),r.username.length+r.balance.length>25?$("#ModalCreditSourceUsername").parent().find(".input-group-prepend").addClass("d-none"):$("#ModalCreditSourceUsername").parent().find(".input-group-prepend").removeClass("d-none"),$("#ModalCreditSourceUsername").val(r.username),$("#ModalCreditSourceBalance").val(r.balance_view),t.hasClass("btn-add-credit")&&e.options.maximumValue(r.balance),r.user_id!=$("body").data("current_user_id")&&($("#ModalCreditSourceContent").removeClass("d-none"),$("#ModalCreditAlert").show())):2==r.position&&($("#ModalCreditDestinationId").val(r.user_id),r.user_id<1e5?$("#ModalCreditDestinationUsername").css("color","#4285f4"):($("#ModalCreditDestinationUsername").css("color","#ff3547"),$("#ModalCreditSourceId").val()==$("body").data("current_user_id")&&($(".modal-credit-register-finance").removeClass("d-none"),$("#ModalCreditRegisterFinanceCollect").parent().parent().removeClass("d-none"),"add"==$("#ModalCreditAction").val()&&$("#ModalCreditRegisterFinanceBonification").parent().parent().removeClass("d-none")),$("#ModalCreditFinanceBalance").attr("data-content",r.finance_balance)),r.username.length>11||r.balance.length>10?($("#ModalCreditDestinationUsername").addClass("px-1"),$("#ModalCreditDestinationBalance").addClass("px-1")):($("#ModalCreditDestinationUsername").removeClass("px-1"),$("#ModalCreditDestinationBalance").removeClass("px-1")),r.username.length+r.balance.length>25?$("#ModalCreditDestinationUsername").parent().find(".input-group-prepend").addClass("d-none"):$("#ModalCreditDestinationUsername").parent().find(".input-group-prepend").removeClass("d-none"),$("#ModalCreditDestinationUsername").val(r.username),$("#ModalCreditDestinationBalance").val(r.balance_view),t.hasClass("btn-deduct-credit")&&e.options.maximumValue(r.balance))})),$("#ModalCreditLoading").hide(),$("#ModalCreditContent").fadeIn(200,(function(){$("#ModalCreditAmount").focus()})),$("#ModalCreditSubmit").removeClass("disabled")},error:function(e){"quick"===$("body").data("quick_use_section")?QuickUseAlert(e.responseText,"error"):ErrorAlert(e.responseText)}})})),$("#users, #UserSearchDiv").on("click",".btn-add-credit",(function(){$("#ModalCreditTitle").text($("body").data("users_modal_credit_add_title")),$("label[for='ModalCreditRegisterFinanceCollect']").text($("body").data("users_modal_credit_finance_collect_title")),$("#ModalCreditAction").val("add")})),$("#users, #UserSearchDiv").on("click",".btn-deduct-credit",(function(){$("#ModalCreditTitle").text($("body").data("users_modal_credit_deduct_title")),$("label[for='ModalCreditRegisterFinanceCollect']").text($("body").data("users_modal_credit_finance_payout_title")),$("#ModalCreditAction").val("deduct")})),$("#UserSearch").on("keyup",(function(e){0==$(this).val().length||$(this).val().length>=3?($(this).removeClass("invalid"),$("#UserSearchButton").removeClass("disabled"),13!=e.keyCode||$("#UserSearchButton").hasClass("disabled")||$("#UserSearchButton").trigger("click")):($(this).addClass("invalid"),$("#UserSearchButton").addClass("disabled"))})),$("#UserSearch").on("blur",(function(){0===$(this).val().length||$(this).val().length>=3?($(this).removeClass("invalid"),$("#UserSearchButton").removeClass("disabled"),$("#UserSearchButton").trigger("click")):($(this).addClass("invalid"),$("#UserSearchButton").addClass("disabled"))})),$(".btn-credit-mod").on("click",(function(){var a=$(this).attr("step"),t=e.settings.maximumValue,r=e.getNumericString();a>0?+r+ +a<=+t?e.set(+r+ +a):e.set(+t):+r+ +a>=0?e.set(+r+ +a):e.set(0),$("#ModalCreditAmount").removeClass("invalid")})),$("#ModalCredit").on("shown.bs.modal",(function(){$("#ModalCreditAmount").focus()})),$("#ModalCredit").on("hidden.bs.modal",(function(){$("#ModalCreditSourceContent").addClass("d-none"),$(".modal-credit-register-finance").addClass("d-none"),$("#ModalCreditRegisterFinanceCollect, #ModalCreditRegisterFinanceBonification").prop("checked",!1).parent().parent().addClass("d-none"),$("#ModalCreditFinanceBalance").attr("data-content",""),$("#ModalCreditContent").hide(),$("#ModalCreditAlert").hide(),$(".modal-clear-val").val(""),e.set(0)})),$("#ModalCreditAmount").on("keyup",(function(e){$(this).removeClass("invalid"),13==e.keyCode&&$("#ModalCreditSubmit").trigger("click")})),$("#ModalCreditSubmit").on("click",(function(){var a=$(this);if(a.hasClass("disabled"))return!1;var t=e.getNumericString();if(0==t)return $("#ModalCreditAmount").addClass("invalid").focus(),!1;a.addClass("disabled");var r=$("#ModalCreditSourceId").val(),i=$("#ModalCreditDestinationId").val(),s=$("#ModalCreditAction").val(),o=$("#ModalCreditRegisterFinanceCollect").prop("checked"),d=$("#ModalCreditRegisterFinanceBonification").prop("checked");$.ajax({url:"services/operation_add_deduct_credit.php",type:"post",cache:!1,data:{source_id:r,destination_id:i,action:s,amount:t,register_finance_collect:o,register_finance_bonification:d,token:$("body").data("session_token")},success:function(e){$("#ModalCredit").modal("hide"),update_own_balance(),"quick"===$("body").data("quick_use_section")?(QuickUseAlert("110","success"),$("#UserSearch").val("")):$("#users").find("tr[user-id="+i+"]").children(".users-row-balance").text(e)},error:function(e){"quick"===$("body").data("quick_use_section")?QuickUseAlert(e.responseText,"error"):ErrorAlert(e.responseText),a.removeClass("disabled")}})})),$(".new-player-input").on("keyup",(function(e){13!=e.keyCode||$("#ModalNewUserPlayerSubmit").hasClass("disabled")||$("#ModalNewUserPlayerSubmit").trigger("click")})),$("#ModalNewUser").on("keyup",".new-affiliate-input",(function(e){13!=e.keyCode||$("#ModalNewUserAffiliateSubmit").hasClass("disabled")||$("#ModalNewUserAffiliateSubmit").trigger("click")})),$("#NewUserButton, #NewPlayerButton, #NewAffiliateButton").on("click",(function(e){"NewUserButton"===e.delegateTarget.id?$("body").data("quick_use_section","users"):$("body").data("quick_use_section","quick"),$.ajax({url:"services/operation_get_providers.php",type:"post",cache:!1,data:{token:$("body").data("session_token")},success:function(e){var a=$.parseJSON(e);$.each(a,(function(e,a){"categories"===e?(providers_categories_tpl("New","Player","Providers",a),providers_categories_tpl("New","Affiliate","Providers",a),providers_categories_tpl("New","Affiliate","Commissions",a)):"providers"===e?(providers_tpl("New","Player",a),providers_tpl("New","Affiliate",a)):"commissions"===e&&commissions_tpl("New","Affiliate",a)})),PercentFormat()},error:function(e){$("#NewUserPlayerLoading").fadeOut(),$("#ModalNewUser").hide(),ErrorAlert(e.responseText)}}),$("body").data("new_user_current_tab",$(this).attr("id")),"NewAffiliateButton"===$("body").data("new_user_current_tab")&&($("#NewUserTabPlayerPanel").toggleClass("active"),$("#NewUserTabPlayer").toggleClass("in show active"),$("#NewUserTabAffiliatePanel").toggleClass("active"),$("#NewUserTabAffiliate").toggleClass("in show active")),$("#ModalNewUser").modal("show")})),$("#NewUserPlayerProviders").on("change",".form-check-input",(function(){if($(this).hasClass("custom-form-check-input")){var e=[t=$(this).attr("data-cat-id")];3==t&&(e.push("4"),e.push("5"),e.push("6"),e.push("7"));var a=$(this).prop("checked");$.each(e,(function(e,t){$("input[id^='NewUserPlayerProviderId"+t+"']").each((function(){$(this).prop("checked",a)}))}))}else{var t;e=[t=parseInt($(this).attr("data-provider-id").substring(0,1))];t>=3&&(e.push("4"),e.push("5"),e.push("6"),e.push("7"));var r=0,i=0;$.each(e,(function(e,a){$("input[id^='NewUserPlayerProviderId"+t+"']").each((function(){$(this).prop("checked")&&r++,i++}))})),0===r?$("#SelectAllNewPlayer"+(t>3?"3":t)).prop("indeterminate",!1).prop("checked",!1):r===i?$("#SelectAllNewPlayer"+(t>3?"3":t)).prop("indeterminate",!1).prop("checked",!0):$("#SelectAllNewPlayer"+(t>3?"3":t)).prop("indeterminate",!0)}})),$("#NewUserAffiliateProviders").on("change",".form-check-input",(function(){if($(this).hasClass("custom-form-check-input")){var e=[t=$(this).attr("data-cat-id")];3==t&&(e.push("4"),e.push("5"),e.push("6"),e.push("7"));var a=$(this).prop("checked");$.each(e,(function(e,t){$("input[id^='NewUserAffiliateProviderId"+t+"']").each((function(){$(this).prop("checked",a)}))}))}else{var t;e=[t=parseInt($(this).attr("data-provider-id").substring(0,1))];t>=3&&(e.push("4"),e.push("5"),e.push("6"),e.push("7"));var r=0,i=0;$.each(e,(function(e,a){$("input[id^='NewUserAffiliateProviderId"+t+"']").each((function(){$(this).prop("checked")&&r++,i++}))})),0===r?$("#SelectAllNewAffiliate"+(t>3?"3":t)).prop("indeterminate",!1).prop("checked",!1):r===i?$("#SelectAllNewAffiliate"+(t>3?"3":t)).prop("indeterminate",!1).prop("checked",!0):$("#SelectAllNewAffiliate"+(t>3?"3":t)).prop("indeterminate",!0)}})),$("#ModalNewUser").on("shown.bs.modal",(function(){$(".password-toggle").each((function(){"password"!==$(this).attr("type")&&$(this).attr("type","password").siblings("i").removeClass("fa-eye").addClass("fa-eye-slash")})),"NewAffiliateButton"===$("body").data("new_user_current_tab")?$("#NewUserAffiliateUsername").focus():$("#NewUserPlayerUsername").focus()})),$("#ModalNewUser").on("hidden.bs.modal",(function(){$(".clear-providers").text(""),$(".modal-clear-val").val("").removeClass("invalid"),$(".modal-clear-tab").trigger("click"),$(this).find("label.active").not("modal-always-active").removeClass("active"),$(".password-toggle").each((function(){"password"==$(this).attr("type")&&$(this).attr("type","text").siblings("i").removeClass("fa-eye").addClass("fa-eye-slash")})),$(".modal-clear-hide").hide(),$("#NewUserAffiliateSettlementPeriod").val("1")})),$("#ModalNewUser").on("keyup",".modal-clear-val",(function(){$(this).removeClass("invalid").siblings("small").fadeOut(),$("#ModalNewUserPlayerSubmit").removeClass("disabled"),$("#ModalNewUserAffiliateSubmit").removeClass("disabled")})),$("#ModalNewUserPlayerSubmit").on("click",(function(){var e=$(this);if(e.hasClass("disabled"))return!1;$("#NewUserPlayerError").hide(),$("#NewUserTabPlayer1Link").trigger("click");var a=0,t=$("#NewUserPlayerUsername"),r=$("#NewUserPlayerPassword");if((t.val().length<4||t.val().length>16)&&(t.addClass("invalid"),$("#NewUserPlayerUsernameFormat").css("display","table-cell"),a=1),(r.val().length<6||r.val().length>16)&&(r.addClass("invalid"),$("#NewUserPlayerPasswordFormat").css("display","table-cell"),a=1),1===a)return e.removeClass("disabled"),$("#NewUserTabPlayer1Link").trigger("click"),!1;e.addClass("disabled"),$("#NewUserPlayerLoading").fadeIn();var i=new Array;$("input[id^='NewUserPlayerProviderId']").each((function(){!0===$(this).prop("checked")&&i.push($(this).attr("data-provider-id"))})),$.ajax({url:"services/operation_create_user.php",type:"post",cache:!1,data:{role:"player",username:t.val(),password:r.val(),name:$("#NewUserPlayerName").val(),passport:$("#NewUserPlayerPassport").val(),email:$("#NewUserPlayerEmail").val(),phone:$("#NewUserPlayerPhone").val(),providers:i,token:$("body").data("session_token")},success:function(e){$("#ModalNewUser").modal("hide"),"quick"===$("body").data("quick_use_section")?QuickUseAlert("111","success"):(UsersTable.clearPipeline().draw(),SuccessAlert("users_new_user_success"))},error:function(a){$("#NewUserPlayerLoading").fadeOut(),ModalUserError(a.responseText,"New","Player",1),e.removeClass("disabled")}})})),$("#ModalNewUserAffiliateSubmit").on("click",(function(){var e=$(this);if(e.hasClass("disabled"))return!1;$("#NewUserAffiliateError").hide();var a=0,t=$("#NewUserAffiliateUsername"),r=$("#NewUserAffiliatePassword");if((t.val().length<4||t.val().length>16)&&(t.addClass("invalid"),$("#NewUserAffiliateUsernameFormat").css("display","table-cell"),a=1),(r.val().length<6||r.val().length>16)&&(r.addClass("invalid"),$("#NewUserAffiliatePasswordFormat").css("display","table-cell"),a=1),1===a)return e.removeClass("disabled"),$("#NewUserTabAffiliate1Link").trigger("click"),!1;e.addClass("disabled");var i=new Array,s=new Array;if($("input[id^='NewUserAffiliateProviderId']").each((function(){if(!0===$(this).prop("checked")){var e=$(this).attr("data-provider-id");""===$("#NewUserAffiliateCommissionId"+e).val()&&(a=1),i.push(e),s.push([e,$("#NewUserAffiliateCommissionId"+e).val()])}})),1===a)return e.removeClass("disabled"),ModalUserError(605,"New","Affiliate",4),!1;$("#NewUserAffiliateLoading").fadeIn(),$.ajax({url:"services/operation_create_user.php",type:"post",cache:!1,data:{role:"affiliate",username:t.val(),password:r.val(),name:$("#NewUserAffiliateName").val(),passport:$("#NewUserAffiliatePassport").val(),email:$("#NewUserAffiliateEmail").val(),phone:$("#NewUserAffiliatePhone").val(),providers:i,period:$("#NewUserAffiliateSettlementPeriod").val(),commissions:s,token:$("body").data("session_token")},success:function(e){$("#ModalNewUser").modal("hide"),"quick"===$("body").data("quick_use_section")?QuickUseAlert("111","success"):(UsersTable.clearPipeline().draw(),LoadTree(),SuccessAlert("users_new_user_success"))},error:function(a){$("#NewUserAffiliateLoading").fadeOut(),ModalUserError(a.responseText,"New","Affiliate",1),e.removeClass("disabled")}})}));var e=new AutoNumeric("#ModalCreditAmount",{currencySymbol:"",currencySymbolPlacement:"p",decimalCharacter:",",decimalCharacterAlternative:".",decimalPlaces:1==$("body").data("number_format")?"2":"0",decimalPlacesRawValue:1==$("body").data("number_format")?"2":"0",digitGroupSeparator:".",emptyInputBehavior:"zero",minimumValue:"0",modifyValueOnWheel:"false",negativePositiveSignPlacement:"r",onInvalidPaste:"clamp",overrideMinMaxLimits:null,roundingMethod:"U",caretPositionOnFocus:"decimalLeft"});$("#NewUserAffiliateCommissions").on("keyup",".select-all-commissions",(function(e){if(Number.isNaN(e.key))return!1;var a=$(this).attr("cat-id"),t=$(this).val();if($("input[id^='NewUserAffiliateCommissionId"+a+"']").each((function(){AutoNumeric.getAutoNumericElement($(this).get(0)).set(t),$(this).trigger("change")})),3==a){$.each([4,5,6,7],(function(e,a){$("input[id^='NewUserAffiliateCommissionId"+a+"']").each((function(){AutoNumeric.getAutoNumericElement($(this).get(0)).set(t),$(this).trigger("change")}))}))}})),$("#QuickUse_alert").on("click",(function(){$(this).hide()}))}));var UsersTable="",QuickUseAlertTimeout="";function QuickUseAlert(e,a){$.ajax({type:"GET",url:"lang/"+$("body").data("current_language")+".xml",dataType:"xml",cache:!1,success:function(t){var r=$(t).find(a+"_"+e).text();r||(r="Unknown message"),$("#QuickUse_alert .alert-span").text(r),"success"===a?$("#QuickUse_alert").removeClass("alert-danger").addClass("alert-success"):$("#QuickUse_alert").removeClass("alert-success").addClass("alert-danger"),$("#QuickUse_alert").fadeIn(),clearTimeout(QuickUseAlertTimeout),QuickUseAlertTimeout=setTimeout((function(){$("#QuickUse_alert").fadeOut(),100==e&&(window.location.href=$("body").data("base_server_path")+"/login.php")}),3e3)}})}function ModalUserError(e,a,t,r){$.ajax({type:"GET",url:"lang/"+$("body").data("current_language")+".xml",dataType:"xml",cache:!1,success:function(i){var s=$(i).find("error_"+e).text();s||(s="Unknown error"),$("#"+a+"UserTab"+t+r+"Link").trigger("click"),$("#"+a+"User"+t+"Error").text(s).fadeIn(),100==e&&(window.location.href=$("body").data("base_server_path")+"/login.php")}})}function providers_categories_tpl(e,a,t,r){var i=0;if($.each(r,(function(r,s){var o='<div class="card mb-3 font-size-custom card-category card-category-'+r+'"> <div class="card-body card-body-category card-body-category-'+r+'">  <div class="col-12 px-0">   <div class="d-inline-block">    <h6 class="card-title">'+s+'</h6>   </div>   <div class="d-inline-block float-right">    <div class="form-check">';"Commissions"===t?o=o+'<div class="md-form input-group font-size-custom"><input type="text" class="form-control modal-clear-val text-right percent-format select-all-commissions" cat-id="'+r+'" id="SelectAllCommissions'+r+'" autocomplete="off"><label for="SelectAllCommissions'+r+'" aria-describedby="material-addonall">'+$("body").data("multi_select_all")+"</label></div>":"Edit"!==e&&(o=o+'     <input type="checkbox" class="form-check-input custom-form-check-input" id="SelectAll'+e+a+r+'" checked="true" data-cat-id="'+r+'">     <label class="form-check-label" for="SelectAll'+e+a+r+'">'+$("body").data("multi_select_all")+"</label>"),o=o+'    </div>   </div>  </div>  <div class="card-text" id="'+e+"User"+a+t+"Category"+r+'Content"></div> </div></div>',$("#"+e+"User"+a+t).append(o),i++})),$(".card-category-1").addClass("border-warning"),$(".card-category-2").addClass("border-success"),$(".card-category-3").addClass("border-primary"),$(".card-body-category-1").addClass("text-warning"),$(".card-body-category-2").addClass("text-success"),$(".card-body-category-3").addClass("text-primary"),1===i){var s=$("#"+e+"User"+a+t).find(".card-category").prop("outerHTML");$("#"+e+"User"+a+t).find(".card-category").remove();var o='<div class="col-10 offset-1 col-sm-6 offset-sm-3 align-top">'+s+"</div>";$("#"+e+"User"+a+t).append(o)}else if(2===i||3===i){s=new Array,$("#"+e+"User"+a+t).find(".card-category").each((function(e){s[e]=this,this.remove()}));var d=document.createElement("div");d.className="col-10 offset-1 col-sm-6 offset-sm-0 d-inline-block";var l=document.createElement("div");l.className="col-10 offset-1 col-sm-6 offset-sm-0 d-inline-block align-top",2===i?(d.innerHTML=s[0].outerHTML,l.innerHTML=s[1].outerHTML):3===i&&(d.innerHTML=s[0].outerHTML+s[1].outerHTML,l.innerHTML=s[2].outerHTML),$("#"+e+"User"+a+t).append(d),$("#"+e+"User"+a+t).append(l)}}function providers_tpl(e,a,t){$.each(t,(function(t,r){var i=document,s=i.createElement("div");s.className="mb-3 font-size-custom";var o=i.createElement("div");o.className="form-check";var d=i.createElement("input");d.type="checkbox",d.className="form-check-input",d.id=e+"User"+a+"ProviderId"+t,d.setAttribute("data-provider-id",t),1===r.enabled&&d.setAttribute("checked",!0);var l=i.createElement("label");l.className="form-check-label",l.setAttribute("for",d.id);var n=i.createTextNode(r.name);l.appendChild(n),o.appendChild(d),o.appendChild(l),s.appendChild(o);var c=parseInt(t.substring(0,1));c>3&&(c=3),$("#"+e+"User"+a+"ProvidersCategory"+c+"Content").append(s)}))}function commissions_tpl(e,a,t){$.each(t,(function(t,r){var i=document,s=i.createElement("div");s.className="col-10 offset-1 md-form input-group mb-5 font-size-custom";var o=i.createElement("input");o.type="text",o.value=r.amount;var d=e.toLowerCase();o.className="form-control "+d+"-affiliate-input modal-clear-val percent-format text-right",o.id=e+"User"+a+"CommissionId"+t,o.setAttribute("autocomplete","off");var l=i.createElement("label");r.amount&&(l.className="active modal-always-active"),l.setAttribute("for",o.id),l.setAttribute("aria-describedby","material-addon"+t);var n=i.createTextNode(r.name),c=i.createElement("div");c.className="input-group-append";var u=i.createElement("span");u.className="input-group-text md-addon",u.id="material-addon"+t;var p=i.createTextNode("%");u.appendChild(p),c.appendChild(u),s.appendChild(o),l.appendChild(n),s.appendChild(o),s.appendChild(l);var m=parseInt(t.substring(0,1));m>3&&(m=3),$("#"+e+"User"+a+"CommissionsCategory"+m+"Content").append(s)}))}